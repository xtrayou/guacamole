<div class="admin-wrapper">
    <div class="container">
        <!-- Premium Header Section -->
        <div class="premium-header">
            <div class="header-main">
                <div class="logo-section">
                    <img src="/img/logo-pwk-1.png" alt="Logo Purwakarta" class="logo-pwk-header" />
                    <div class="header-text">
                        <h1>SISKEUDES</h1>
                    </div>
                </div>
                
                <!-- Modern Tabs di Header -->
                <div class="header-tabs">
                    <button class="header-tab active" onclick="showTab('users')">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                            <path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
                                stroke="currentColor" stroke-width="2" />
                        </svg>
                        <span>User</span>
                    </button>

                    <button class="header-tab" onclick="showTab('connections')">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                            <rect x="3" y="4" width="18" height="12" rx="2" stroke="currentColor" stroke-width="2" />
                            <path d="M8 20h8M12 16v4" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                        </svg>
                        <span>RDP Connections</span>
                    </button>

                    <button class="header-tab" onclick="showTab('mapping')">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                            <path d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" />
                            <path d="M9 12l2 2 4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                        </svg>
                        <span>User Mapping</span>
                    </button>
                </div>
                
                <div class="user-info">
                    <div class="user-avatar">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                            <path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
                                stroke="currentColor" stroke-width="2" />
                        </svg>
                    </div>
                    <div class="user-details">
                        <span class="user-name">nama#</span>
                        <span class="user-role">Admin</span>
                    </div>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="stats-grid">
                <div class="stat-card stat-primary">
                    <div class="stat-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                            <path
                                d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"
                                stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                        </svg>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value" id="total-users">-</div>
                        <div class="stat-label">Total Users</div>
                    </div>
                </div>

                <div class="stat-card stat-success">
                    <div class="stat-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                            <rect x="2" y="3" width="20" height="14" rx="2" stroke="currentColor" stroke-width="2" />
                            <path d="M8 21h8M12 17v4" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                        </svg>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value" id="total-connections">-</div>
                        <div class="stat-label">RDP Connections</div>
                    </div>
                </div>

                <div class="stat-card stat-warning">
                    <div class="stat-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                            <path
                                d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2M13 7a4 4 0 11-8 0 4 4 0 018 0zM23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75"
                                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value" id="active-users">0</div>
                        <div class="stat-label">Active Users</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Users Tab -->
        <div id="tab-users" class="tab-content">
            <div style="display: flex; gap: 2rem;">
                <div style="flex: 1;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3>Users List</h3>
                        <button onclick="showUserForm()">+ Add User</button>
                    </div>
                    <div class="card">
                        <table>
                            <thead>
                                <tr>
                                    <th>Username</th>
                                    <th>Role</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody hx-get="/api/users" hx-trigger="load, userCreated from:body">
                                <!-- Users list -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Create User Form (Hidden by default) -->
                <div id="user-form-container" style="flex: 1; display: none;">
                    <h3>Create New User</h3>
                    <div class="card">
                        <form hx-post="/api/create-user" hx-target="#user-form-message">
                            <div style="display: flex; flex-direction: column;">
                                <label>Username</label>
                                <input type="text" name="username" required>

                                <label>Password</label>
                                <input type="password" name="password" required minlength="6">

                                <label>Full Name (Optional)</label>
                                <input type="text" name="full_name">

                                <label>Email (Optional)</label>
                                <input type="email" name="email">

                                <label>Role</label>
                                <select name="role">
                                    <option value="user">User</option>
                                    <option value="admin">Admin</option>
                                </select>

                                <button type="submit">Create User</button>
                                <button type="button" onclick="hideUserForm()">Cancel</button>
                            </div>
                            <div id="user-form-message" style="margin-top: 1rem;"></div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Connections Tab -->
        <div id="tab-connections" class="tab-content" style="display: none;">
            <div style="display: flex; gap: 2rem;">
                <div style="flex: 1;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3>RDP Connections</h3>
                        <button onclick="showConnectionForm()">+ Add Connection</button>
                    </div>
                    <div class="card">
                        <table>
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Host</th>
                                    <th>Port</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody hx-get="/api/connections" hx-trigger="load, connectionCreated from:body">
                                <!-- Connections list -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Create Connection Form -->
                <div id="connection-form-container" style="flex: 1; display: none;">
                    <h3>Create RDP Connection</h3>
                    <div class="card">
                        <form hx-post="/api/create-connection" hx-target="#connection-form-message">
                            <div style="display: flex; flex-direction: column;">
                                <label>Connection Name</label>
                                <input type="text" name="name" required placeholder="e.g., Server1">

                                <label>Hostname/IP</label>
                                <input type="text" name="hostname" required placeholder="192.168.1.100">

                                <label>Port</label>
                                <input type="number" name="port" value="3389" required>

                                <label>Username (Optional)</label>
                                <input type="text" name="rdp_username" placeholder="RDP login username">

                                <label>Password (Optional)</label>
                                <input type="password" name="rdp_password" placeholder="RDP login password">

                                <label>Domain (Optional)</label>
                                <input type="text" name="domain" placeholder="DOMAIN">

                                <label>Security Mode</label>
                                <select name="security">
                                    <option value="any">Any</option>
                                    <option value="nla">NLA (Network Level Auth)</option>
                                    <option value="tls">TLS</option>
                                    <option value="rdp">RDP</option>
                                </select>

                                <label>Ignore Server Certificate</label>
                                <select name="ignore_cert">
                                    <option value="true">Yes</option>
                                    <option value="false">No</option>
                                </select>

                                <button type="submit">Create Connection</button>
                                <button type="button" onclick="hideConnectionForm()">Cancel</button>
                            </div>
                            <div id="connection-form-message" style="margin-top: 1rem;"></div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mapping Tab -->
        <div id="tab-mapping" class="tab-content" style="display: none;">
            <div style="display: flex; gap: 2rem;">
                <div style="flex: 1;">
                    <h3>Users</h3>
                    <div class="card">
                        <table>
                            <thead>
                                <tr>
                                    <th>Username</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody hx-get="/api/users" hx-trigger="load">
                                <!-- Users list -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div style="flex: 1;">
                    <h3>Connection Mapping</h3>
                    <div class="card" id="mapping-area">
                        Select a user to manage connections.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Load stats on page load
        document.addEventListener('DOMContentLoaded', function () {
            loadStats();
            // Refresh stats every 60 seconds
            setInterval(loadStats, 60000);
        });

        function loadStats() {
            // Load all stats from single API call
            fetch('/api/stats')
                .then(res => res.json())
                .then(data => {
                    const totalUsers = data.totalUsers || 0;
                    const totalConnections = data.totalConnections || 0;
                    const activeCount = data.activeUsers || 0;

                    // Update and animate all stats
                    document.getElementById('total-users').textContent = totalUsers;
                    document.getElementById('total-connections').textContent = totalConnections;
                    document.getElementById('active-users').textContent = activeCount;

                    animateValue('total-users', 0, totalUsers, 800);
                    animateValue('total-connections', 0, totalConnections, 800);
                    animateValue('active-users', 0, activeCount, 600);
                })
                .catch(err => {
                    console.error('Error loading stats:', err);
                    document.getElementById('total-users').textContent = '0';
                    document.getElementById('total-connections').textContent = '0';
                    document.getElementById('active-users').textContent = '0';
                });
        }

        // Animate number counting up
        function animateValue(id, start, end, duration) {
            const element = document.getElementById(id);
            if (!element) return;

            const range = end - start;
            const increment = range / (duration / 16); // 60fps
            let current = start;

            const timer = setInterval(() => {
                current += increment;
                if (current >= end) {
                    element.textContent = end;
                    clearInterval(timer);
                } else {
                    element.textContent = Math.floor(current);
                }
            }, 16);
        }

        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            // Remove active class from all buttons
            document.querySelectorAll('.header-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            // Show selected tab
            document.getElementById('tab-' + tabName).style.display = 'block';
            // Add active class to clicked button
            event.target.closest('.header-tab').classList.add('active');
        }

        function showUserForm() {
            document.getElementById('user-form-container').style.display = 'block';
        }

        function hideUserForm() {
            document.getElementById('user-form-container').style.display = 'none';
            document.getElementById('user-form-message').innerHTML = '';
        }

        function showConnectionForm() {
            document.getElementById('connection-form-container').style.display = 'block';
        }

        function hideConnectionForm() {
            document.getElementById('connection-form-container').style.display = 'none';
            document.getElementById('connection-form-message').innerHTML = '';
        }
    </script>

    <!-- Edit User Modal -->
    <div id="edit-user-modal" class="modal">
        <div class="modal-content">
            <h3>Edit User</h3>
            <form id="edit-user-form" hx-put="" hx-target="#edit-user-message">
                <div style="display: flex; flex-direction: column;">
                    <label>Username</label>
                    <input type="text" name="username" id="edit-username" required>

                    <label>New Password (leave blank to keep current)</label>
                    <input type="password" name="password" placeholder="New Password">

                    <div style="margin-top: 1rem; display: flex; gap: 1rem;">
                        <button type="submit">Save Changes</button>
                        <button type="button" onclick="closeEditUserModal()"
                            style="background: #6b7280;">Cancel</button>
                    </div>
                </div>
                <div id="edit-user-message" style="margin-top: 1rem;"></div>
            </form>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="modal" style="display: none;">
        <div class="modal-content confirm-modal-content">
            <div class="confirm-icon">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none">
                    <circle cx="12" cy="12" r="10" stroke="#f59e0b" stroke-width="2" />
                    <path d="M12 8v4M12 16h.01" stroke="#f59e0b" stroke-width="2" stroke-linecap="round" />
                </svg>
            </div>
            <h3 id="confirm-title">Are you sure?</h3>
            <p id="confirm-message">This action cannot be undone.</p>
            <div class="confirm-actions">
                <button type="button" class="btn-confirm" onclick="confirmAction()">Yes, Delete</button>
                <button type="button" class="btn-cancel-confirm" onclick="closeConfirmModal()">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // ROLE_INJECTION_PLACEHOLDER

        document.addEventListener('DOMContentLoaded', function () {
            if (typeof CURRENT_ROLE !== 'undefined' && CURRENT_ROLE === 'ADMIN') {
                const roleSelect = document.querySelector('select[name="role"]');
                if (roleSelect) {
                    roleSelect.value = 'user';
                    roleSelect.style.display = 'none';
                    roleSelect.previousElementSibling.style.display = 'none';
                }
            }
        });

        function openEditUserModal(id, username, role) {
            const modal = document.getElementById('edit-user-modal');
            const form = document.getElementById('edit-user-form');
            const usernameInput = document.getElementById('edit-username');

            form.setAttribute('hx-put', '/api/user/' + id);
            htmx.process(form);

            usernameInput.value = username;
            modal.style.display = 'block';
        }

        function closeEditUserModal() {
            document.getElementById('edit-user-modal').style.display = 'none';
            document.getElementById('edit-user-message').innerHTML = '';
        }

        window.onclick = function (event) {
            const modal = document.getElementById('edit-user-modal');
            const confirmModal = document.getElementById('confirm-modal');
            if (event.target == modal) {
                closeEditUserModal();
            }
            if (event.target == confirmModal) {
                closeConfirmModal();
            }
        }

        // Confirmation Modal Functions
        let pendingDeleteAction = null;

        function showConfirmModal(title, message, callback) {
            document.getElementById('confirm-title').textContent = title;
            document.getElementById('confirm-message').textContent = message;
            pendingDeleteAction = callback;
            document.getElementById('confirm-modal').style.display = 'block';
        }

        function closeConfirmModal() {
            document.getElementById('confirm-modal').style.display = 'none';
            pendingDeleteAction = null;
        }

        function confirmAction() {
            if (pendingDeleteAction) {
                pendingDeleteAction();
                closeConfirmModal();
            }
        }

        // Intercept DELETE button clicks to show custom confirmation modal
        document.addEventListener('click', function (e) {
            // Check if clicked element is a delete button with data-confirm
            const deleteBtn = e.target.closest('button[hx-delete][data-confirm]');

            if (deleteBtn) {
                e.preventDefault();
                e.stopPropagation();

                const message = deleteBtn.getAttribute('data-confirm') || 'Are you sure you want to delete this?';

                showConfirmModal(
                    'Confirm Delete',
                    message,
                    function () {
                        // Remove data-confirm and trigger HTMX delete
                        deleteBtn.removeAttribute('data-confirm');
                        htmx.trigger(deleteBtn, 'click');
                    }
                );

                return false;
            }
        }, true); // Use capture phase to intercept before HTMX
    </script>

    </body>

    </html>
<div class="admin-wrapper">
    <!-- Top Header -->
    <header class="top-header">
        <div class="logo-section">
            <img src="/img/logo-pwk-1.png" alt="Logo Purwakarta" class="header-logo" />
            <h1>SISKEUDES</h1>
        </div>
        <div class="header-title">
            <h2>Dashboard</h2>
        </div>
        <div class="header-right">
            <div class="notification-icon" onclick="showLoginHistory()" title="Login History">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span class="notification-badge" id="history-count">0</span>
            </div>
            <div class="user-info">
                <div class="user-avatar">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />
                        <circle cx="12" cy="7" r="4" />
                    </svg>
                </div>
                <div class="user-details">
                    <span class="user-name" id="current-username">Admin</span>
                    <span class="user-role">Admin</span>
                </div>
            </div>
        </div>
    </header>

    <div class="main-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <nav class="sidebar-nav">
                <button class="sidebar-item active" onclick="showTab('users')">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
                        <circle cx="9" cy="7" r="4" />
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87" />
                        <path d="M16 3.13a4 4 0 0 1 0 7.75" />
                    </svg>
                    <span>User Management</span>
                </button>

                <button class="sidebar-item" onclick="showTab('connections')">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="2" y="7" width="20" height="14" rx="2" ry="2" />
                        <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16" />
                    </svg>
                    <span>RDP connection</span>
                </button>

                <button class="sidebar-item" onclick="showTab('mapping')">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="7" height="7" />
                        <rect x="14" y="3" width="7" height="7" />
                        <rect x="14" y="14" width="7" height="7" />
                        <rect x="3" y="14" width="7" height="7" />
                    </svg>
                    <span>User Mapping</span>
                </button>

                <button class="sidebar-item" onclick="showTab('settings')">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3" />
                        <path
                            d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z" />
                    </svg>
                    <span>Settings</span>
                </button>

                <button class="sidebar-item logout-btn" onclick="window.location.href='/'">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
                        <polyline points="16 17 21 12 16 7" />
                        <line x1="21" y1="12" x2="9" y2="12" />
                    </svg>
                    <span>LogOut</span>
                </button>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="breadcrumb">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="7" height="7" />
                    <rect x="14" y="3" width="7" height="7" />
                    <rect x="14" y="14" width="7" height="7" />
                    <rect x="3" y="14" width="7" height="7" />
                </svg>
                <span>Dashboard</span>
            </div>

            <h2 class="page-title">Admin Control Center</h2>

            <!-- Stats Cards -->
            <div class="stats-grid">
                <div class="stat-card stat-blue">
                    <div class="stat-icon">
                        <svg width="32" height="32" viewBox="0 0 24 24" fill="white">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
                            <circle cx="9" cy="7" r="4" />
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87" />
                            <path d="M16 3.13a4 4 0 0 1 0 7.75" />
                        </svg>
                    </div>
                    <div class="stat-content">
                        <div class="stat-label">Total Users</div>
                        <div class="stat-value" id="total-users">0</div>
                    </div>
                </div>

                <div class="stat-card stat-green">
                    <div class="stat-icon">
                        <svg width="32" height="32" viewBox="0 0 24 24" fill="white">
                            <rect x="2" y="7" width="20" height="14" rx="2" ry="2" />
                            <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16" />
                        </svg>
                    </div>
                    <div class="stat-content">
                        <div class="stat-label">RDP Connections</div>
                        <div class="stat-value" id="total-connections">0</div>
                    </div>
                </div>

                <div class="stat-card stat-orange">
                    <div class="stat-icon">
                        <svg width="32" height="32" viewBox="0 0 24 24" fill="white">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
                            <circle cx="9" cy="7" r="4" />
                        </svg>
                    </div>
                    <div class="stat-content">
                        <div class="stat-label">Active Users</div>
                        <div class="stat-value" id="active-users">0</div>
                    </div>
                </div>

                <div class="stat-card stat-purple">
                    <div class="stat-icon">
                        <svg width="32" height="32" viewBox="0 0 24 24" fill="white">
                            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                            <polyline points="9,22 9,12 15,12 15,22"/>
                        </svg>
                    </div>
                    <div class="stat-content">
                        <div class="stat-label">Total Desa</div>
                        <div class="stat-value" id="total-desa">0</div>
                    </div>
                </div>
            </div>

            <!-- Users Tab -->
            <div id="tab-users" class="tab-content">
                <div class="content-header">
                    <h3>Users List</h3>
                    <div style="display: flex; gap: 1rem; align-items: center;">
                        <div style="position: relative; display: flex; align-items: center;">
                            <input type="text" id="user-search" placeholder="Cari berdasarkan username atau desa..." style="padding: 0.5rem 2.5rem 0.5rem 0.5rem; border: 1px solid #ddd; border-radius: 4px; width: 350px; font-size: 0.9rem;" onkeyup="handleUserSearch(event)">
                            <button id="clear-search" onclick="clearSearch()" style="position: absolute; right: 0.5rem; background: none; border: none; color: #999; cursor: pointer; padding: 0; font-size: 1.2rem; display: none;" title="Clear search">×</button>
                        </div>
                        <button class="btn-primary" onclick="showUserForm()">+ Add User</button>
                    </div>
                </div>
                <div class="card">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Username</th>
                                <th>Desa</th>
                                <th>Role</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="users-body">
                            <!-- Users loaded via HTMX -->
                        </tbody>
                    </table>
                        <div class="table-footer" style="display:flex; justify-content:space-between; align-items:center; padding:0.75rem 1rem; border-top: 1px solid #E0E0E0; background: #F8F9FA;">
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <div>
                                    <label style="font-size:0.875rem; color:#6C757D;">Rows per page:</label>
                                    <select id="users-per-page" onchange="reloadUsers(1)" style="padding: 0.25rem; border: 1px solid #ddd; border-radius: 4px; margin-left: 0.5rem;">
                                        <option value="5">5</option>
                                        <option value="10" selected>10</option>
                                        <option value="25">25</option>
                                        <option value="50">50</option>
                                    </select>
                                </div>
                                <div id="search-info" style="font-size: 0.875rem; color: #28C76F; font-weight: 500; display: none;"></div>
                            </div>
                            <div id="users-pagination" style="display:flex; gap:0.5rem; align-items:center;">
                                <button class="btn-sm" id="users-prev" onclick="changePage(-1)" style="padding: 0.4rem 0.8rem;">‹ Prev</button>
                                <span id="users-page-info" style="font-size:0.9rem; color:#6C757D; margin: 0 1rem;">Page 1 of 1</span>
                                <button class="btn-sm" id="users-next" onclick="changePage(1)" style="padding: 0.4rem 0.8rem;">Next ›</button>
                            </div>
                        </div>
                </div>
            </div>

            <!-- Connections Tab -->
            <div id="tab-connections" class="tab-content" style="display: none;">
                <div class="content-header">
                    <h3>RDP Connections</h3>
                    <button class="btn-primary" onclick="showConnectionForm()">+ Add Connection</button>
                </div>
                <div class="card">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Host</th>
                                <th>Port</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody hx-get="/api/connections" hx-trigger="load, connectionCreated from:body">
                            <!-- Connections loaded via HTMX -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Mapping Tab -->
            <div id="tab-mapping" class="tab-content" style="display: none;">
                <div class="content-header">
                    <h3>User Mapping</h3>
                </div>
                <div class="card" id="mapping-container">
                    <p class="text-muted" style="padding: 2rem; text-align: center;">Select "Manage Conns" from the User
                        list to configure mappings.</p>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="tab-settings" class="tab-content" style="display: none;">
                <div class="content-header">
                    <h3>Settings</h3>
                </div>
                <div class="card">
                    <div style="padding: 2rem;">
                        <h4 style="margin-bottom: 1.5rem; font-size: 1.1rem; font-weight: 600;">Appearance</h4>
                        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                <path
                                    d="M12 2.25a.75.75 0 01.75.75v2.25a.75.75 0 01-1.5 0V3a.75.75 0 01.75-.75zM7.5 12a4.5 4.5 0 119 0 4.5 4.5 0 01-9 0zM18.894 6.166a.75.75 0 00-1.06-1.06l-1.591 1.59a.75.75 0 101.06 1.061l1.591-1.59zM21.75 12a.75.75 0 01-.75.75h-2.25a.75.75 0 010-1.5H21a.75.75 0 01.75.75zM17.834 18.894a.75.75 0 001.06-1.06l-1.59-1.591a.75.75 0 10-1.061 1.06l1.59 1.591zM12 18a.75.75 0 01.75.75V21a.75.75 0 01-1.5 0v-2.25A.75.75 0 0112 18zM7.758 17.303a.75.75 0 00-1.061-1.06l-1.591 1.59a.75.75 0 001.06 1.061l1.591-1.59zM6 12a.75.75 0 01-.75.75H3a.75.75 0 010-1.5h2.25A.75.75 0 016 12zM6.697 7.757a.75.75 0 001.06-1.06l-1.59-1.591a.75.75 0 00-1.061 1.06l1.59 1.591z" />
                            </svg>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; margin-bottom: 0.25rem;">Light Mode</div>
                                <div style="font-size: 0.875rem; color: var(--text-gray);">Bright theme for daytime use</div>
                            </div>
                            <label class="theme-switch">
                                <input type="radio" name="theme" value="light" checked onchange="setTheme('light')">
                                <span class="theme-slider"></span>
                            </label>
                        </div>
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                <path
                                    d="M9.528 1.718a.75.75 0 01.162.819A8.97 8.97 0 009 6a9 9 0 009 9 8.97 8.97 0 003.463-.69.75.75 0 01.981.98 10.503 10.503 0 01-9.694 6.46c-5.799 0-10.5-4.701-10.5-10.5 0-4.368 2.667-8.112 6.46-9.694a.75.75 0 01.818.162z" />
                            </svg>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; margin-bottom: 0.25rem;">Dark Mode</div>
                                <div style="font-size: 0.875rem; color: var(--text-gray);">Dark theme for nighttime use</div>
                            </div>
                            <label class="theme-switch">
                                <input type="radio" name="theme" value="dark" onchange="setTheme('dark')">
                                <span class="theme-slider"></span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Login History Modal -->
    <div id="history-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h3 style="margin: 0;">Login History</h3>
                <button onclick="closeHistoryModal()"
                    style="background: transparent; border: none; cursor: pointer; font-size: 1.5rem; padding: 0; color: #6C757D;">×</button>
            </div>
            <div id="history-list">
                <div style="padding: 1rem; background: #F5F7FA; border-radius: 8px; margin-bottom: 0.75rem;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <strong>guacadmin</strong>
                        <span style="color: #28C76F; font-size: 0.875rem;">● Active</span>
                    </div>
                    <div style="font-size: 0.875rem; color: #6C757D;">
                        <div>IP: 192.168.1.100</div>
                        <div>Time: 2025-11-28 10:30:45</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add User Modal -->
    <div id="add-user-modal" class="modal">
        <div class="modal-content">
            <h3>Add New User</h3>
            <form onsubmit="handleCreateUser(event)">
                <div style="display: flex; flex-direction: column;">
                    <label>Username</label>
                    <input type="text" name="username" required>

                    <label>Desa</label>
                    <input type="text" name="desa" placeholder="Nama Desa">

                    <label>Role</label>
                    <select name="role">
                        <option value="USER">User</option>
                        <option value="ADMIN">Admin</option>
                        <option value="SUPERADMIN">Superadmin</option>
                    </select>

                    <label>Password</label>
                    <input type="password" name="password" required>

                    <div style="margin-top: 1rem; display: flex; gap: 1rem;">
                        <button type="submit" class="btn-primary">Create User</button>
                        <button type="button" onclick="closeModal('add-user-modal')"
                            style="background: #6b7280;">Cancel</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Connection Modal -->
    <div id="add-connection-modal" class="modal">
        <div class="modal-content">
            <h3>Add New Connection</h3>
            <form hx-post="/api/connections" hx-target="#tab-connections tbody" hx-swap="beforeend"
                onsubmit="closeModal('add-connection-modal')">
                <div style="display: flex; flex-direction: column;">
                    <label>Connection Name</label>
                    <input type="text" name="name" required>

                    <label>Host</label>
                    <input type="text" name="host" required>

                    <label>Port</label>
                    <input type="number" name="port" value="3389" required>

                    <label>Type</label>
                    <select name="type">
                        <option value="rdp">RDP</option>
                        <option value="vnc">VNC</option>
                        <option value="ssh">SSH</option>
                    </select>

                    <div style="margin-top: 1rem; display: flex; gap: 1rem;">
                        <button type="submit" class="btn-primary">Create Connection</button>
                        <button type="button" onclick="closeModal('add-connection-modal')"
                            style="background: #6b7280;">Cancel</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div id="edit-user-modal" class="modal">
        <div class="modal-content">
            <h3>Edit User</h3>
            <form id="edit-user-form" hx-put="" hx-target="#edit-user-target" hx-swap="outerHTML"
                onsubmit="closeModal('edit-user-modal')">
                <div style="display: flex; flex-direction: column;">
                    <label>Username</label>
                    <input type="text" name="username" id="edit-username" required>

                    <label>Desa</label>
                    <input type="text" name="desa" id="edit-desa" placeholder="Nama Desa">

                    <label>Role</label>
                    <select name="role" id="edit-role">
                        <option value="USER">User</option>
                        <option value="ADMIN">Admin</option>
                        <option value="SUPERADMIN">Superadmin</option>
                    </select>

                    <label>New Password (leave blank to keep current)</label>
                    <input type="password" name="password" placeholder="New Password">

                    <div style="margin-top: 1rem; display: flex; gap: 1rem;">
                        <button type="submit" class="btn-primary">Save Changes</button>
                        <button type="button" onclick="closeModal('edit-user-modal')"
                            style="background: #6b7280;">Cancel</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Connection Modal -->
    <div id="edit-connection-modal" class="modal">
        <div class="modal-content">
            <h3>Edit Connection</h3>
            <form id="edit-connection-form" hx-put="" hx-target="#edit-connection-target" hx-swap="outerHTML"
                onsubmit="closeModal('edit-connection-modal')">
                <div style="display: flex; flex-direction: column;">
                    <label>Connection Name</label>
                    <input type="text" name="name" id="edit-conn-name" required>

                    <label>Host</label>
                    <input type="text" name="host" id="edit-conn-host" required>

                    <label>Port</label>
                    <input type="number" name="port" id="edit-conn-port" required>

                    <label>Type</label>
                    <select name="type" id="edit-conn-type">
                        <option value="rdp">RDP</option>
                        <option value="vnc">VNC</option>
                        <option value="ssh">SSH</option>
                    </select>

                    <div style="margin-top: 1rem; display: flex; gap: 1rem;">
                        <button type="submit" class="btn-primary">Save Changes</button>
                        <button type="button" onclick="closeModal('edit-connection-modal')"
                            style="background: #6b7280;">Cancel</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="modal" style="display: none;">
        <div class="modal-content confirm-modal-content">
            <div class="confirm-icon">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none">
                    <circle cx="12" cy="12" r="10" stroke="#f59e0b" stroke-width="2" />
                    <path d="M12 8v4M12 16h.01" stroke="#f59e0b" stroke-width="2" stroke-linecap="round" />
                </svg>
            </div>
            <h3 id="confirm-title">Are you sure?</h3>
            <p id="confirm-message">This action cannot be undone.</p>
            <div class="confirm-actions">
                <button type="button" class="btn-confirm" onclick="confirmAction()">Yes, Delete</button>
                <button type="button" class="btn-cancel-confirm" onclick="closeConfirmModal()">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // Tab switching function
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.style.display = 'none');
            document.querySelectorAll('.sidebar-item').forEach(btn => btn.classList.remove('active'));
            document.getElementById('tab-' + tabName).style.display = 'block';

            // Find the sidebar button that calls this function
            const btn = Array.from(document.querySelectorAll('.sidebar-item')).find(b => b.getAttribute('onclick').includes(tabName));
            if (btn) btn.classList.add('active');
        }

        // Stats
        document.addEventListener('DOMContentLoaded', function () {
            loadStats();
            setInterval(loadStats, 60000);
            // initialize users pagination
            reloadUsers(1);
        });

        function loadStats() {
            fetch('/api/stats')
                .then(res => res.json())
                .then(data => {
                    document.getElementById('total-users').textContent = data.totalUsers || 0;
                    document.getElementById('total-connections').textContent = data.totalConnections || 0;
                    document.getElementById('active-users').textContent = data.activeUsers || 0;
                    document.getElementById('total-desa').textContent = data.totalDesa || 0;
                })
                .catch(console.error);
        }

        // Users pagination state & helpers
        const usersState = { page: 1, limit: 10, total: 0 };

        function updatePaginationInfo() {
            const maxPage = Math.max(1, Math.ceil(usersState.total / usersState.limit));
            document.getElementById('users-page-info').textContent = `Page ${usersState.page} of ${maxPage}`;
            document.getElementById('users-prev').disabled = usersState.page <= 1;
            document.getElementById('users-next').disabled = usersState.page >= maxPage;
            
            // Show search info if filtering
            const searchInput = document.getElementById('user-search');
            const searchInfo = document.getElementById('search-info');
            if (searchInput && searchInput.value.trim()) {
                searchInfo.textContent = `Found ${usersState.total} users`;
                searchInfo.style.display = 'block';
            } else {
                searchInfo.style.display = 'none';
            }
            
            // update total users stat card only if not searching
            if (!searchInput || !searchInput.value.trim()) {
                const totalEl = document.getElementById('total-users');
                if (totalEl) totalEl.textContent = usersState.total;
            }
        }

        function reloadUsers(page) {
            usersState.page = page || usersState.page || 1;
            usersState.limit = parseInt(document.getElementById('users-per-page').value, 10) || 10;
            const search = document.getElementById('user-search').value.trim();
            let url = `/api/users?page=${usersState.page}&limit=${usersState.limit}`;
            if (search) url += `&search=${encodeURIComponent(search)}`;
            fetch(url, { headers: { 'HX-Request': 'true' } })
                .then(async res => {
                    const text = await res.text();
                    document.getElementById('users-body').innerHTML = text;
                    // let HTMX process any attributes in the inserted HTML
                    if (window.htmx) htmx.process(document.getElementById('users-body'));
                    usersState.total = parseInt(res.headers.get('X-Total-Count') || '0', 10) || 0;
                    updatePaginationInfo();
                })
                .catch(err => {
                    console.error('Failed to load users:', err);
                });
        }

        function changePage(delta) {
            const maxPage = Math.max(1, Math.ceil(usersState.total / usersState.limit));
            let newPage = (usersState.page || 1) + delta;
            if (newPage < 1) newPage = 1;
            if (newPage > maxPage) newPage = maxPage;
            if (newPage === usersState.page) return;
            reloadUsers(newPage);
        }

        // Search handler with debounce
        let searchTimeout;
        function handleUserSearch(event) {
            const searchInput = document.getElementById('user-search');
            const clearBtn = document.getElementById('clear-search');
            
            // Show/hide clear button
            if (searchInput.value.trim()) {
                clearBtn.style.display = 'block';
            } else {
                clearBtn.style.display = 'none';
            }
            
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                reloadUsers(1); // Reset to first page when searching
            }, 300); // Reduced debounce time for better UX
        }

        function clearSearch() {
            const searchInput = document.getElementById('user-search');
            const clearBtn = document.getElementById('clear-search');
            searchInput.value = '';
            clearBtn.style.display = 'none';
            reloadUsers(1); // Reload without search filter
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl+F or Cmd+F to focus search (only when users tab is active)
            if ((e.ctrlKey || e.metaKey) && e.key === 'f' && document.getElementById('tab-users').style.display !== 'none') {
                e.preventDefault();
                document.getElementById('user-search').focus();
            }
            // Escape to clear search
            if (e.key === 'Escape' && document.getElementById('user-search').value) {
                clearSearch();
            }
        });

        // Modals
        function showUserForm() {
            document.getElementById('add-user-modal').style.display = 'block';
        }

        function showConnectionForm() {
            document.getElementById('add-connection-modal').style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Edit User
        let editUserTarget = null;
        function editUser(id, username, role, desa = '') {
            const modal = document.getElementById('edit-user-modal');
            const form = document.getElementById('edit-user-form');

            // Find the row to update
            const btn = event.target;
            editUserTarget = btn.closest('tr');
            editUserTarget.id = 'edit-user-target'; // Temporary ID for HTMX target

            form.setAttribute('hx-put', '/api/users/' + id);
            htmx.process(form);

            document.getElementById('edit-username').value = username;
            document.getElementById('edit-role').value = role;
            document.getElementById('edit-desa').value = desa;

            modal.style.display = 'block';
        }

        // Edit Connection
        let editConnectionTarget = null;
        function editConnection(id, name, host, port, type) {
            const modal = document.getElementById('edit-connection-modal');
            const form = document.getElementById('edit-connection-form');

            // Find the row to update
            const btn = event.target;
            editConnectionTarget = btn.closest('tr');
            editConnectionTarget.id = 'edit-connection-target'; // Temporary ID for HTMX target

            form.setAttribute('hx-put', '/api/connections/' + id);
            htmx.process(form);

            document.getElementById('edit-conn-name').value = name;
            document.getElementById('edit-conn-host').value = host;
            document.getElementById('edit-conn-port').value = port;
            document.getElementById('edit-conn-type').value = type;

            modal.style.display = 'block';
        }

        // Manage Connections
        function manageConnections(userId, username) {
            showTab('mapping');
            const container = document.getElementById('mapping-container');
            container.innerHTML = '<div style="padding: 2rem; text-align: center;">Loading...</div>';

            fetch(`/api/mappings/${userId}`)
                .then(res => res.json())
                .then(data => {
                    const { mappings, allConnections } = data;
                    let html = `
                        <div style="padding: 1.5rem;">
                            <h4>Manage Connections for <strong>${username}</strong></h4>
                            <p style="margin-bottom: 1rem; color: #666;">Select the connections this user should have access to.</p>
                            <div class="connections-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1rem;">
                    `;

                    if (allConnections.length === 0) {
                        html += `<p>No connections available. Create one in the RDP Connection tab.</p>`;
                    } else {
                        allConnections.forEach(conn => {
                            const isChecked = mappings.includes(conn.id) ? 'checked' : '';
                            html += `
                                <div class="connection-item" style="border: 1px solid #e2e8f0; padding: 1rem; border-radius: 0.5rem; display: flex; align-items: center; gap: 0.75rem; background: #fff;">
                                    <input type="checkbox" id="conn-${conn.id}" ${isChecked} onchange="toggleMapping(${userId}, ${conn.id}, this.checked)" style="width: 1.2rem; height: 1.2rem;">
                                    <label for="conn-${conn.id}" style="cursor: pointer; flex: 1;">
                                        <div style="font-weight: 600;">${conn.name}</div>
                                        <div style="font-size: 0.875rem; color: #64748b;">${conn.host}:${conn.port}</div>
                                    </label>
                                </div>
                            `;
                        });
                    }

                    html += `</div></div>`;
                    container.innerHTML = html;
                });
        }

        function toggleMapping(userId, connectionId, isChecked) {
            fetch('/api/mappings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    userId,
                    connectionId,
                    action: isChecked ? 'add' : 'remove'
                })
            }).catch(err => {
                console.error('Error updating mapping:', err);
                alert('Failed to update mapping');
            });
        }

        // Create user via fetch to ensure pagination refresh
        function handleCreateUser(event) {
            event.preventDefault();
            const form = event.target;
            const fd = new FormData(form);
            const body = {};
            for (const [k, v] of fd.entries()) body[k] = v;

            fetch('/api/users', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            })
                .then(async res => {
                    if (!res.ok) throw new Error('Create failed');
                    closeModal('add-user-modal');
                    // reload first page to include the new user
                    reloadUsers(1);
                })
                .catch(err => {
                    console.error('Failed to create user:', err);
                    alert('Failed to create user');
                });
        }

        // Delete user via API and refresh current page
        function deleteUser(id) {
            showConfirmModal('Confirm Delete', 'Are you sure you want to delete this user?', async function () {
                try {
                    const res = await fetch('/api/users/' + id, { method: 'DELETE' });
                    if (!res.ok) throw new Error('Delete failed');
                    // reload current page
                    reloadUsers(usersState.page || 1);
                } catch (err) {
                    console.error('Failed to delete user:', err);
                    alert('Failed to delete user');
                }
            });
        }

        // Confirmation Modal
        let pendingDeleteAction = null;

        function showConfirmModal(title, message, callback) {
            document.getElementById('confirm-title').textContent = title;
            document.getElementById('confirm-message').textContent = message;
            pendingDeleteAction = callback;
            document.getElementById('confirm-modal').style.display = 'block';
        }

        function closeConfirmModal() {
            document.getElementById('confirm-modal').style.display = 'none';
            pendingDeleteAction = null;
        }

        function confirmAction() {
            if (pendingDeleteAction) {
                pendingDeleteAction();
                closeConfirmModal();
            }
        }

        // Intercept DELETE button clicks
        document.addEventListener('click', function (e) {
            const deleteBtn = e.target.closest('button[hx-delete][data-confirm]');
            if (deleteBtn) {
                e.preventDefault();
                e.stopPropagation();
                const message = deleteBtn.getAttribute('data-confirm');
                showConfirmModal('Confirm Delete', message, function () {
                    deleteBtn.removeAttribute('data-confirm');
                    htmx.trigger(deleteBtn, 'click');
                });
                return false;
            }
        }, true);

        // Close modals on outside click
        window.onclick = function (event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
                if (event.target.id === 'edit-user-modal' && editUserTarget) {
                    editUserTarget.removeAttribute('id');
                    editUserTarget = null;
                }
                if (event.target.id === 'edit-connection-modal' && editConnectionTarget) {
                    editConnectionTarget.removeAttribute('id');
                    editConnectionTarget = null;
                }
            }
        }

        // Theme switcher
        function setTheme(theme) {
            if (theme === 'dark') {
                document.body.classList.add('dark-theme');
                document.body.classList.remove('light-theme');
            } else {
                document.body.classList.add('light-theme');
                document.body.classList.remove('dark-theme');
            }
            localStorage.setItem('theme', theme);
        }

        window.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme') || 'light';
            const themeRadio = document.querySelector(`input[name="theme"][value="${savedTheme}"]`);
            if (themeRadio) themeRadio.checked = true;
            setTheme(savedTheme);
        });
    </script>
</div>